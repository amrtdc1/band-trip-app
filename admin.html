<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Admin ‚Äì Universal Analytics</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Monoton&display=swap" rel="stylesheet">
  <link href="./styles.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <style>
    .tabs {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1.5rem;
      border-bottom: 2px solid var(--color-border-subtle);
    }
    .tab {
      padding: 0.75rem 1.5rem;
      background: transparent;
      border: none;
      border-bottom: 3px solid transparent;
      cursor: pointer;
      font-weight: 600;
      color: var(--color-text-muted);
      transition: all 0.2s;
    }
    .tab.active {
      color: var(--color-accent);
      border-bottom-color: var(--color-accent);
    }
    .tab-content {
      display: none;
    }
    .tab-content.active {
      display: block;
    }
    .charts-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: 1.5rem;
      margin-bottom: 2rem;
    }
    .chart-container {
      background: var(--color-card);
      padding: 1.5rem;
      border-radius: 12px;
      border: 1px solid var(--color-border-subtle);
      box-shadow: var(--shadow-soft);
    }
    .chart-container h3 {
      margin-top: 0;
      margin-bottom: 1rem;
      font-size: 1rem;
      color: var(--color-text);
    }
    .chart-wrapper {
      position: relative;
      height: 280px;
    }
    
    /* Itinerary Builder Styles */
    .itinerary-builder {
      display: grid;
      grid-template-columns: 250px 1fr;
      gap: 1.5rem;
      margin-top: 1.5rem;
    }
    @media (max-width: 768px) {
      .itinerary-builder {
        grid-template-columns: 1fr;
      }
      .attractions-library {
        max-height: 300px;
      }
    }
    .attractions-library {
      background: var(--color-card);
      padding: 1rem;
      border-radius: 12px;
      border: 1px solid var(--color-border-subtle);
      max-height: 600px;
      overflow-y: auto;
    }
    .attractions-library h4 {
      margin-top: 0;
      font-size: 0.9rem;
      text-transform: uppercase;
      color: var(--color-text-muted);
    }
    .attraction-card {
      background: var(--chip-bg);
      border: 1px solid var(--chip-border);
      padding: 0.6rem;
      margin-bottom: 0.5rem;
      border-radius: 8px;
      cursor: grab;
      font-size: 0.85rem;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    .attraction-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .attraction-card.dragging {
      opacity: 0.5;
      cursor: grabbing;
    }
    .attraction-card .attraction-name {
      font-weight: 600;
      color: var(--color-text);
    }
    .attraction-card .attraction-park {
      font-size: 0.75rem;
      color: var(--color-text-muted);
      margin-top: 0.25rem;
    }
    
    .schedule-grid {
      display: grid;
      gap: 1.5rem;
    }
    .day-schedule {
      background: var(--color-card);
      border: 1px solid var(--color-border-subtle);
      border-radius: 12px;
      padding: 1.5rem;
    }
    .day-schedule h3 {
      margin-top: 0;
      margin-bottom: 1rem;
      color: var(--color-accent);
    }
    .timeslots {
      display: grid;
      gap: 0.75rem;
    }
    .timeslot {
      background: var(--color-surface);
      border: 2px dashed var(--color-border-subtle);
      border-radius: 8px;
      padding: 0.75rem;
      min-height: 80px;
      transition: background 0.2s, border-color 0.2s;
    }
    .timeslot.drag-over {
      background: var(--color-accent-soft);
      border-color: var(--color-accent);
    }
    .timeslot-header {
      font-size: 0.85rem;
      font-weight: 600;
      color: var(--color-text-muted);
      margin-bottom: 0.5rem;
    }
    .timeslot-items {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }
    .scheduled-item {
      background: var(--color-accent-soft);
      border: 1px solid var(--color-accent);
      padding: 0.5rem;
      border-radius: 6px;
      font-size: 0.85rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .scheduled-item .remove-btn {
      background: transparent;
      border: none;
      color: var(--color-danger);
      cursor: pointer;
      padding: 0;
      font-size: 1.2rem;
      line-height: 1;
    }
    
    .stats-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-bottom: 1.5rem;
    }
    .stat-card {
      background: var(--color-card);
      padding: 1.25rem;
      border-radius: 12px;
      border: 1px solid var(--color-border-subtle);
      text-align: center;
    }
    .stat-number {
      font-size: 2.5rem;
      font-weight: 700;
      color: var(--color-accent);
      line-height: 1;
    }
    .stat-label {
      font-size: 0.85rem;
      color: var(--color-text-muted);
      margin-top: 0.5rem;
    }
  </style>
</head>
<body>
  <div class="app-shell">
    <header class="app-header">
      <div class="app-title-row">
        <div class="app-title">
          <span class="icon">üéõÔ∏è</span>
          <span class="universal-title">Universal Trip ‚Äì Admin</span>
        </div>
        <div class="theme-selector">
          <button id="theme-selector" aria-label="Theme selector" title="Change theme">
            <span class="icon">‚òÄÔ∏è</span><span class="label">Light</span>
          </button>
        </div>
        <span class="app-badge">Director View</span>
      </div>
      <p class="app-subtitle">
        Live analytics, charts, and itinerary builder based on student submissions.
      </p>
    </header>

    <div id="gate" class="card">
      <p>Sign in with your Google account to view analytics & itinerary.</p>
      <button type="button" id="login">Sign in with Google</button>
      <div id="who" class="muted"></div>
    </div>

    <div id="app" style="display:none;">
      <div class="card" style="display: flex; justify-content: space-between; align-items: center;">
        <div>
          <p id="currentUser" style="margin: 0;"></p>
        </div>
        <button type="button" id="logout" style="padding: 8px 16px;">Sign out</button>
      </div>

      <div class="tabs">
        <button type="button" class="tab active" data-tab="analytics">üìä Analytics</button>
        <button type="button" class="tab" data-tab="itinerary">üìÖ Itinerary Builder</button>
        <button type="button" class="tab" data-tab="data">üíæ Data Export</button>
      </div>

      <!-- Analytics Tab -->
      <div id="analytics" class="tab-content active">
        <div class="stats-row" id="statsRow"></div>
        <div class="charts-grid">
          <div class="chart-container">
            <h3>Coaster Comfort Level</h3>
            <div class="chart-wrapper">
              <canvas id="comfortChart"></canvas>
            </div>
          </div>
          <div class="chart-container">
            <h3>Thrill vs Cautious Breakdown</h3>
            <div class="chart-wrapper">
              <canvas id="thrillChart"></canvas>
            </div>
          </div>
          <div class="chart-container">
            <h3>Top Themes Requested</h3>
            <div class="chart-wrapper">
              <canvas id="themesChart"></canvas>
            </div>
          </div>
          <div class="chart-container">
            <h3>Common Concerns/Avoids</h3>
            <div class="chart-wrapper">
              <canvas id="avoidsChart"></canvas>
            </div>
          </div>
        </div>
      </div>

      <!-- Itinerary Builder Tab -->
      <div id="itinerary" class="tab-content">
        <div class="card">
          <h2>Drag & Drop Itinerary Builder</h2>
          <p style="color: var(--color-text-muted); margin-bottom: 1.5rem;">
            Drag attractions from the library into time slots. Remove items by clicking the √ó button.
          </p>
          <div class="itinerary-builder">
            <div class="attractions-library" id="attractionsLibrary">
              <h4>üé¢ Attractions Library</h4>
              <div id="attractionsList"></div>
            </div>
            <div class="schedule-grid" id="scheduleGrid"></div>
          </div>
        </div>
      </div>

      <!-- Data Export Tab -->
      <div id="data" class="tab-content">
        <div class="card">
          <h2>Data Export & Summary</h2>
          <div id="summary"></div>
          <button type="button" id="download" style="margin-top: 1rem;">Download JSON</button>
          <span id="status" style="margin-left: 1rem; color: var(--color-text-muted);"></span>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import { app, auth, onAuth, signInAdminWithGoogle } from './firebase-init.js';
    import { signOut } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-auth.js";
    import { getFirestore, collection, getDocs, query, orderBy, doc, getDoc } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-firestore.js";

    const db = getFirestore(app);
    let charts = {};
    let submissionsData = null;

    // Tab switching
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        tab.classList.add('active');
        document.getElementById(tab.dataset.tab).classList.add('active');
      });
    });

    // Auth
    document.getElementById('login').addEventListener('click', signInAdminWithGoogle);
    document.getElementById('logout').addEventListener('click', () => {
      signOut(auth).then(() => {
        document.getElementById('gate').style.display = 'block';
        document.getElementById('app').style.display = 'none';
      });
    });

    onAuth(async (user) => {
      if (!user) return;
      try {
        const idTokenResult = await user.getIdTokenResult(true);
        if (!idTokenResult.claims.admin) {
          document.getElementById('who').textContent = `Access denied for ${user.email}`;
          return;
        }
        document.getElementById('gate').style.display = 'none';
        document.getElementById('app').style.display = 'block';
        document.getElementById('currentUser').textContent = `Logged in as: ${user.email}`;
        await loadAndRender();
      } catch (err) {
        document.getElementById('who').textContent = 'Error verifying admin status';
      }
    });

    async function loadAndRender() {
      const snap = await getDocs(query(collection(db, 'submissions'), orderBy('timestamp', 'asc')));
      submissionsData = snap.docs.map(d => d.data());
      renderAnalytics(submissionsData);
      initializeItineraryBuilder();
      setupDataExport(submissionsData);
    }

    function renderAnalytics(subs) {
      const total = subs.length;
      const comfortCounts = {1:0,2:0,3:0,4:0,5:0};
      const themes = {};
      const avoidCounts = {};
      const buckets = {thrill:0, flexible:0, cautious:0};

      subs.forEach(s => {
        const c = Number(s.coaster_comfort||0);
        if (comfortCounts[c] != null) comfortCounts[c]++;
        if (c >= 4) buckets.thrill++;
        else if (c === 3) buckets.flexible++;
        else if (c > 0) buckets.cautious++;

        (s.top_themes||[]).forEach(t => {
          const k = t.trim().toLowerCase();
          if (k) themes[k] = (themes[k]||0) + 1;
        });

        const avoidText = [
          ...(s.avoid_ride_list || []),
          s.usf_choices||"", s.ioa_choices||"", s.epic_choices||"", s.parent_restrictions||""
        ].join(" ").toLowerCase();

        ["velocicoaster","hulk","rip ride rockit","hagrid","dark universe","scary","heights","motion sickness","simulator"].forEach(k => {
          if (avoidText.includes(k)) avoidCounts[k] = (avoidCounts[k]||0) + 1;
        });
      });

      // Stats cards
      document.getElementById('statsRow').innerHTML = `
        <div class="stat-card">
          <div class="stat-number">${total}</div>
          <div class="stat-label">Total Submissions</div>
        </div>
        <div class="stat-card">
          <div class="stat-number">${buckets.thrill}</div>
          <div class="stat-label">Thrill Seekers</div>
        </div>
        <div class="stat-card">
          <div class="stat-number">${buckets.flexible}</div>
          <div class="stat-label">Flexible</div>
        </div>
        <div class="stat-card">
          <div class="stat-number">${buckets.cautious}</div>
          <div class="stat-label">Cautious</div>
        </div>
      `;

      // Coaster Comfort Chart (Bar)
      if (charts.comfort) charts.comfort.destroy();
      charts.comfort = new Chart(document.getElementById('comfortChart'), {
        type: 'bar',
        data: {
          labels: ['1 (No way)', '2', '3 (Okay)', '4', '5 (Love)'],
          datasets: [{
            label: 'Students',
            data: [comfortCounts[1], comfortCounts[2], comfortCounts[3], comfortCounts[4], comfortCounts[5]],
            backgroundColor: ['#ef4444', '#fb923c', '#fbbf24', '#4ade80', '#22c55e']
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } }
        }
      });

      // Thrill Breakdown (Doughnut)
      if (charts.thrill) charts.thrill.destroy();
      charts.thrill = new Chart(document.getElementById('thrillChart'), {
        type: 'doughnut',
        data: {
          labels: ['Thrill', 'Flexible', 'Cautious'],
          datasets: [{
            data: [buckets.thrill, buckets.flexible, buckets.cautious],
            backgroundColor: ['#22c55e', '#fbbf24', '#ef4444']
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false
        }
      });

      // Top Themes (Horizontal Bar)
      const topThemes = Object.entries(themes).sort((a,b) => b[1] - a[1]).slice(0, 8);
      if (charts.themes) charts.themes.destroy();
      charts.themes = new Chart(document.getElementById('themesChart'), {
        type: 'bar',
        data: {
          labels: topThemes.map(([k]) => k),
          datasets: [{
            label: 'Requests',
            data: topThemes.map(([,v]) => v),
            backgroundColor: '#2563eb'
          }]
        },
        options: {
          indexAxis: 'y',
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } }
        }
      });

      // Avoids (Bar)
      const topAvoids = Object.entries(avoidCounts).sort((a,b) => b[1] - a[1]).slice(0, 8);
      if (charts.avoids) charts.avoids.destroy();
      charts.avoids = new Chart(document.getElementById('avoidsChart'), {
        type: 'bar',
        data: {
          labels: topAvoids.map(([k]) => k),
          datasets: [{
            label: 'Students',
            data: topAvoids.map(([,v]) => v),
            backgroundColor: '#dc2626'
          }]
        },
        options: {
          indexAxis: 'y',
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } }
        }
      });
    }

    function initializeItineraryBuilder() {
      const attractions = [
        {name: "Hagrid's Magical Creatures", park: "IOA"},
        {name: "VelociCoaster", park: "IOA"},
        {name: "Hulk", park: "IOA"},
        {name: "Harry Potter - Forbidden Journey", park: "IOA"},
        {name: "Spider-Man", park: "IOA"},
        {name: "Seuss Landing", park: "IOA"},
        {name: "Rip Ride Rockit", park: "USF"},
        {name: "Mummy", park: "USF"},
        {name: "Gringotts", park: "USF"},
        {name: "Minions", park: "USF"},
        {name: "Transformers", park: "USF"},
        {name: "Super Nintendo World", park: "Epic"},
        {name: "Ministry of Magic", park: "Epic"},
        {name: "Dark Universe", park: "Epic"},
        {name: "How to Train Your Dragon", park: "Epic"}
      ];

      const schedule = {
        thursday: ["2:00 PM", "3:00 PM", "4:00 PM", "5:00 PM", "6:00 PM"],
        friday: ["9:00 AM", "10:00 AM", "11:00 AM", "12:00 PM", "1:00 PM", "2:00 PM", "3:00 PM", "4:00 PM", "5:00 PM", "6:00 PM"],
        saturday: ["9:00 AM", "10:00 AM", "11:00 AM", "12:00 PM", "1:00 PM", "2:00 PM", "3:00 PM", "4:00 PM", "5:00 PM"]
      };

      // Render attractions library
      const attractionsList = document.getElementById('attractionsList');
      attractions.forEach(attr => {
        const card = document.createElement('div');
        card.className = 'attraction-card';
        card.draggable = true;
        card.dataset.attraction = JSON.stringify(attr);
        card.innerHTML = `
          <div class="attraction-name">${attr.name}</div>
          <div class="attraction-park">${attr.park}</div>
        `;
        card.addEventListener('dragstart', handleDragStart);
        card.addEventListener('dragend', handleDragEnd);
        attractionsList.appendChild(card);
      });

      // Render schedule grid
      const scheduleGrid = document.getElementById('scheduleGrid');
      ['thursday', 'friday', 'saturday'].forEach(day => {
        const dayCard = document.createElement('div');
        dayCard.className = 'day-schedule';
        dayCard.innerHTML = `<h3>${day.charAt(0).toUpperCase() + day.slice(1)}</h3><div class="timeslots" id="${day}-slots"></div>`;
        scheduleGrid.appendChild(dayCard);

        const slotsContainer = document.getElementById(`${day}-slots`);
        schedule[day].forEach(time => {
          const slot = document.createElement('div');
          slot.className = 'timeslot';
          slot.dataset.day = day;
          slot.dataset.time = time;
          slot.innerHTML = `
            <div class="timeslot-header">${time}</div>
            <div class="timeslot-items"></div>
          `;
          slot.addEventListener('dragover', handleDragOver);
          slot.addEventListener('dragleave', handleDragLeave);
          slot.addEventListener('drop', handleDrop);
          slotsContainer.appendChild(slot);
        });
      });
    }

    let draggedElement = null;

    function handleDragStart(e) {
      draggedElement = this;
      this.classList.add('dragging');
      e.dataTransfer.effectAllowed = 'copy';
      e.dataTransfer.setData('text/html', this.innerHTML);
    }

    function handleDragEnd(e) {
      this.classList.remove('dragging');
    }

    function handleDragOver(e) {
      if (e.preventDefault) e.preventDefault();
      e.dataTransfer.dropEffect = 'copy';
      this.classList.add('drag-over');
      return false;
    }

    function handleDragLeave(e) {
      this.classList.remove('drag-over');
    }

    function handleDrop(e) {
      if (e.stopPropagation) e.stopPropagation();
      this.classList.remove('drag-over');

      if (draggedElement) {
        const data = JSON.parse(draggedElement.dataset.attraction);
        const itemsContainer = this.querySelector('.timeslot-items');
        
        const scheduledItem = document.createElement('div');
        scheduledItem.className = 'scheduled-item';
        scheduledItem.innerHTML = `
          <span><strong>${data.name}</strong> (${data.park})</span>
          <button type="button" class="remove-btn" onclick="this.parentElement.remove()">√ó</button>
        `;
        itemsContainer.appendChild(scheduledItem);
      }

      return false;
    }

    function setupDataExport(subs) {
      const total = subs.length;
      document.getElementById('summary').innerHTML = `
        <p><strong>Total Submissions:</strong> ${total}</p>
        <p style="color: var(--color-text-muted); font-size: 0.9rem;">Click the button below to download all submission data as JSON.</p>
      `;

      document.getElementById('download').onclick = () => {
        const blob = new Blob([JSON.stringify({ submissions: subs }, null, 2)], {type:'application/json'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'universal_band_trip_responses.json';
        a.click();
        URL.revokeObjectURL(a.href);
        document.getElementById('status').textContent = 'Downloaded!';
        setTimeout(() => document.getElementById('status').textContent = '', 3000);
      };
    }
  </script>
  <script>
    (function(){
      const btn = document.getElementById('theme-selector');
      const root = document.documentElement;
      const themes = ['light','dark','universal'];
      const icons = { light: '‚òÄÔ∏è', dark: 'üåô', universal: 'üåê' };
      const labels = { light: 'Light', dark: 'Dark', universal: 'Universal' };
      function applyTheme(t){
        root.classList.remove('theme-dark','theme-universal');
        if (t === 'dark') root.classList.add('theme-dark');
        if (t === 'universal') root.classList.add('theme-universal');
        localStorage.setItem('theme', t);
        if (!btn) return;
        btn.querySelector('.icon').textContent = icons[t] || '';
        btn.querySelector('.label').textContent = labels[t] || t;
      }
      const stored = localStorage.getItem('theme');
      const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
      const start = stored || (prefersDark ? 'dark' : 'light');
      applyTheme(start);
      if (btn) {
        btn.addEventListener('click', () => {
          const cur = localStorage.getItem('theme') || (prefersDark ? 'dark' : 'light');
          const next = themes[(themes.indexOf(cur) + 1) % themes.length];
          applyTheme(next);
        });
      }
    })();
  </script>
</body>
</html>
