<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Admin ‚Äì Universal Analytics</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Monoton&display=swap" rel="stylesheet">
  <link href="./styles.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <style>
    .tabs {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1.5rem;
      border-bottom: 2px solid var(--color-border-subtle);
    }
    .tab {
      padding: 0.75rem 1.5rem;
      background: transparent;
      border: none;
      border-bottom: 3px solid transparent;
      cursor: pointer;
      font-weight: 600;
      color: var(--color-text-muted);
      transition: all 0.2s;
    }
    .tab.active {
      color: var(--color-accent);
      border-bottom-color: var(--color-accent);
    }
    .tab-content {
      display: none;
    }
    .tab-content.active {
      display: block;
    }
    .charts-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: 1.5rem;
      margin-bottom: 2rem;
    }
    .chart-container {
      background: var(--color-card);
      padding: 1.5rem;
      border-radius: 12px;
      border: 1px solid var(--color-border-subtle);
      box-shadow: var(--shadow-soft);
    }
    .chart-container h3 {
      margin-top: 0;
      margin-bottom: 1rem;
      font-size: 1rem;
      color: var(--color-text);
    }
    .chart-wrapper {
      position: relative;
      height: 280px;
    }
    
    /* Itinerary Builder Styles */
    .itinerary-builder {
      display: grid;
      grid-template-columns: 250px 1fr;
      gap: 1.5rem;
      margin-top: 1.5rem;
    }
    @media (max-width: 768px) {
      .itinerary-builder {
        grid-template-columns: 1fr;
      }
      .attractions-library {
        max-height: 300px;
      }
    }
    .attractions-library {
      background: var(--color-card);
      padding: 1rem;
      border-radius: 12px;
      border: 1px solid var(--color-border-subtle);
      max-height: 600px;
      overflow-y: auto;
    }
    .attractions-library h4 {
      margin-top: 0;
      font-size: 0.9rem;
      text-transform: uppercase;
      color: var(--color-text-muted);
    }
    .attraction-card {
      background: var(--chip-bg);
      border: 1px solid var(--chip-border);
      padding: 0.6rem;
      margin-bottom: 0.5rem;
      border-radius: 8px;
      cursor: grab;
      font-size: 0.85rem;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    .attraction-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .attraction-card.dragging {
      opacity: 0.5;
      cursor: grabbing;
    }
    .attraction-card .attraction-name {
      font-weight: 600;
      color: var(--color-text);
    }
    .attraction-card .attraction-park {
      font-size: 0.75rem;
      color: var(--color-text-muted);
      margin-top: 0.25rem;
    }
    
    .schedule-grid {
      display: grid;
      gap: 1.5rem;
    }
    .day-schedule {
      background: var(--color-card);
      border: 1px solid var(--color-border-subtle);
      border-radius: 12px;
      padding: 1.5rem;
    }
    .day-schedule h3 {
      margin-top: 0;
      margin-bottom: 1rem;
      color: var(--color-accent);
    }
    .timeslots {
      display: grid;
      gap: 0.75rem;
    }
    .timeslot {
      background: var(--color-surface);
      border: 2px dashed var(--color-border-subtle);
      border-radius: 8px;
      padding: 0.75rem;
      min-height: 80px;
      transition: background 0.2s, border-color 0.2s;
    }
    .timeslot.drag-over {
      background: var(--color-accent-soft);
      border-color: var(--color-accent);
    }
    .timeslot-header {
      font-size: 0.85rem;
      font-weight: 600;
      color: var(--color-text-muted);
      margin-bottom: 0.5rem;
    }
    .timeslot-items {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }
    .scheduled-item {
      background: var(--color-accent-soft);
      border: 1px solid var(--color-accent);
      padding: 0.5rem;
      border-radius: 6px;
      font-size: 0.85rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .scheduled-item .remove-btn {
      background: transparent;
      border: none;
      color: var(--color-danger);
      cursor: pointer;
      padding: 0;
      font-size: 1.2rem;
      line-height: 1;
    }
    
    .stats-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-bottom: 1.5rem;
    }
    .stat-card {
      background: var(--color-card);
      padding: 1.25rem;
      border-radius: 12px;
      border: 1px solid var(--color-border-subtle);
      text-align: center;
    }
    .stat-number {
      font-size: 2.5rem;
      font-weight: 700;
      color: var(--color-accent);
      line-height: 1;
    }
    .stat-label {
      font-size: 0.85rem;
      color: var(--color-text-muted);
      margin-top: 0.5rem;
    }
    .filter-group {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
      margin-bottom: 1rem;
    }
    .filter-chip {
      padding: 0.5rem 1rem;
      border: 2px solid var(--color-border-subtle);
      background: var(--color-surface);
      border-radius: 20px;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 0.85rem;
      font-weight: 500;
    }
    .filter-chip:hover {
      border-color: var(--color-accent);
      transform: translateY(-2px);
    }
    .filter-chip.active {
      background: var(--color-accent);
      color: white;
      border-color: var(--color-accent);
    }
    .chaperone-selector {
      margin-bottom: 1.5rem;
      padding: 1rem;
      background: var(--color-surface);
      border-radius: 8px;
      border: 1px solid var(--color-border-subtle);
    }
    .chaperone-selector label {
      display: block;
      font-weight: 600;
      margin-bottom: 0.5rem;
      color: var(--color-text);
    }
    .chaperone-selector select {
      width: 100%;
      max-width: 400px;
      padding: 0.75rem;
      border: 1px solid var(--color-border-subtle);
      border-radius: 8px;
      background: var(--color-card);
      color: var(--color-text);
      font-size: 1rem;
      cursor: pointer;
    }
    .chaperone-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem;
      background: var(--color-surface);
      border: 1px solid var(--color-border-subtle);
      border-radius: 8px;
    }
    .chaperone-item .name {
      font-weight: 600;
      color: var(--color-text);
    }
    .chaperone-item .delete-btn {
      padding: 0.5rem 1rem;
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
      border: none;
      color: white;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.85rem;
      transition: opacity 0.2s;
    }
    .chaperone-item .delete-btn:hover {
      opacity: 0.9;
    }
  </style>
</head>
<body>
  <div class="app-shell">
    <header class="app-header">
      <div class="app-title-row">
        <div class="app-title">
          <span class="icon">üéõÔ∏è</span>
          <span class="universal-title">Universal Trip ‚Äì Admin</span>
        </div>
        <div class="theme-selector">
          <button id="theme-selector" aria-label="Theme selector" title="Change theme">
            <span class="icon">‚òÄÔ∏è</span><span class="label">Light</span>
          </button>
        </div>
        <span class="app-badge">Director View</span>
      </div>
      <p class="app-subtitle">
        Live analytics, charts, and itinerary builder based on student submissions.
      </p>
    </header>

    <div id="gate" class="card">
      <p>Sign in with your Google account to view analytics & itinerary.</p>
      <button type="button" id="login">Sign in with Google</button>
      <div id="who" class="muted"></div>
    </div>

    <div id="app" style="display:none;">
      <div class="card" style="display: flex; justify-content: space-between; align-items: center;">
        <div>
          <p id="currentUser" style="margin: 0;"></p>
        </div>
        <button type="button" id="logout" style="padding: 8px 16px;">Sign out</button>
      </div>

      <div class="tabs">
        <button type="button" class="tab active" data-tab="analytics">üìä Analytics</button>
        <button type="button" class="tab" data-tab="itinerary">üìÖ Itinerary Builder</button>
        <button type="button" class="tab" data-tab="chaperones">üë• Chaperones</button>
        <button type="button" class="tab" data-tab="data">üíæ Data Export</button>
      </div>

      <!-- Analytics Tab -->
      <div id="analytics" class="tab-content active">
        <div class="chaperone-selector">
          <label for="chaperoneFilter">üéØ Filter by Chaperone Group</label>
          <select id="chaperoneFilter">
            <option value="all">All Students (Full Group)</option>
          </select>
        </div>
        <div class="stats-row" id="statsRow"></div>
        <div class="charts-grid">
          <div class="chart-container">
            <h3>Coaster Comfort Level</h3>
            <div class="chart-wrapper">
              <canvas id="comfortChart"></canvas>
            </div>
          </div>
          <div class="chart-container">
            <h3>Thrill vs Cautious Breakdown</h3>
            <div class="chart-wrapper">
              <canvas id="thrillChart"></canvas>
            </div>
          </div>
          <div class="chart-container">
            <h3>Top Themes Requested</h3>
            <div class="chart-wrapper">
              <canvas id="themesChart"></canvas>
            </div>
          </div>
          <div class="chart-container">
            <h3>Common Concerns/Avoids</h3>
            <div class="chart-wrapper">
              <canvas id="avoidsChart"></canvas>
            </div>
          </div>
        </div>
      </div>

      <!-- Itinerary Builder Tab -->
      <div id="itinerary" class="tab-content">
        <div class="card">
          <h2>Drag & Drop Itinerary Builder</h2>
          <p style="color: var(--color-text-muted); margin-bottom: 0.5rem;">
            Drag attractions from the library into time slots. Remove items by clicking the √ó button.
          </p>
          <div style="display: flex; gap: 1rem; margin-bottom: 1rem; align-items: center; flex-wrap: wrap;">
            <button type="button" id="autoGenerateBtn" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); padding: 0.75rem 1.5rem;">
              ‚ú® Auto-Generate from Survey Data
            </button>
            <button type="button" id="clearScheduleBtn" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); padding: 0.75rem 1.5rem;">
              üóëÔ∏è Clear Schedule
            </button>
          </div>
          <div style="background: var(--color-surface); padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem; border: 1px solid var(--color-border-subtle);">
            <h4 style="margin-top: 0; font-size: 0.9rem; margin-bottom: 0.75rem;">üîç Filter Attractions</h4>
            <div style="margin-bottom: 1rem;">
              <label style="font-size: 0.85rem; font-weight: 600; display: block; margin-bottom: 0.5rem;">By Category:</label>
              <div class="filter-group" id="categoryFilters">
                <button type="button" class="filter-chip active" data-category="all">All</button>
                <button type="button" class="filter-chip" data-category="üé¢">üé¢ Thrill Rides</button>
                <button type="button" class="filter-chip" data-category="üé°">üé° Family Rides</button>
                <button type="button" class="filter-chip" data-category="üé≠">üé≠ Shows</button>
                <button type="button" class="filter-chip" data-category="üçî">üçî Dining</button>
                <button type="button" class="filter-chip" data-category="üé™">üé™ Interactive</button>
              </div>
            </div>
            <div>
              <label style="font-size: 0.85rem; font-weight: 600; display: block; margin-bottom: 0.5rem;">By Park:</label>
              <div class="filter-group" id="parkFilters">
                <button type="button" class="filter-chip active" data-park="all">All Parks</button>
                <button type="button" class="filter-chip" data-park="IOA">IOA</button>
                <button type="button" class="filter-chip" data-park="USF">USF</button>
                <button type="button" class="filter-chip" data-park="Epic">Epic Universe</button>
              </div>
            </div>
          </div>
          <div class="itinerary-builder">
            <div class="attractions-library" id="attractionsLibrary">
              <h4>üé¢ Attractions Library</h4>
              <div id="attractionsList"></div>
            </div>
            <div class="schedule-grid" id="scheduleGrid"></div>
          </div>
        </div>
      </div>

      <!-- Chaperones Management Tab -->
      <div id="chaperones" class="tab-content">
        <div class="card">
          <h2>üë• Manage Chaperone List</h2>
          <p style="color: var(--color-text-muted); margin-bottom: 1.5rem;">
            Add or remove chaperones. Changes will immediately update the student form dropdown.
          </p>
          
          <div style="display: flex; gap: 1rem; margin-bottom: 2rem; align-items: flex-start;">
            <div style="flex: 1;">
              <label style="display: block; font-weight: 600; margin-bottom: 0.5rem;">Add New Chaperone</label>
              <input type="text" id="newChaperoneName" placeholder="e.g., Mrs. Anderson" style="width: 100%; padding: 0.75rem; border: 1px solid var(--color-border-subtle); border-radius: 8px; font-size: 1rem;" />
            </div>
            <button type="button" id="addChaperoneBtn" style="margin-top: 1.85rem; padding: 0.75rem 1.5rem; background: linear-gradient(135deg, #10b981 0%, #059669 100%);">‚ûï Add</button>
          </div>
          
          <div>
            <h3 style="margin-bottom: 1rem;">Current Chaperones</h3>
            <div id="chaperonesList" style="display: grid; gap: 0.75rem;"></div>
          </div>
        </div>
      </div>

      <!-- Data Export Tab -->
      <div id="data" class="tab-content">
        <div class="card">
          <h2>Data Export & Summary</h2>
          <div id="summary"></div>
          <button type="button" id="download" style="margin-top: 1rem;">Download JSON</button>
          <span id="status" style="margin-left: 1rem; color: var(--color-text-muted);"></span>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import { app, auth, onAuth, signInAdminWithGoogle } from './firebase-init.js';
    import { signOut } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-auth.js";
    import { getFirestore, collection, getDocs, query, orderBy, doc, getDoc, setDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-firestore.js";

    const db = getFirestore(app);
    let charts = {};
    let submissionsData = null;
    let allAttractions = [];
    let activeFilters = {
      category: 'all',
      park: 'all',
      chaperone: 'all'
    };

    // Tab switching
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        tab.classList.add('active');
        document.getElementById(tab.dataset.tab).classList.add('active');
      });
    });

    // Auth
    document.getElementById('login').addEventListener('click', signInAdminWithGoogle);
    document.getElementById('logout').addEventListener('click', () => {
      signOut(auth).then(() => {
        document.getElementById('gate').style.display = 'block';
        document.getElementById('app').style.display = 'none';
      });
    });

    onAuth(async (user) => {
      if (!user) return;
      try {
        const idTokenResult = await user.getIdTokenResult(true);
        if (!idTokenResult.claims.admin) {
          document.getElementById('who').textContent = `Access denied for ${user.email}`;
          return;
        }
        document.getElementById('gate').style.display = 'none';
        document.getElementById('app').style.display = 'block';
        document.getElementById('currentUser').textContent = `Logged in as: ${user.email}`;
        await loadAndRender();
      } catch (err) {
        document.getElementById('who').textContent = 'Error verifying admin status';
      }
    });

    async function loadAndRender() {
      const snap = await getDocs(query(collection(db, 'submissions'), orderBy('timestamp', 'asc')));
      submissionsData = snap.docs.map(d => d.data());
      
      // Populate chaperone dropdown
      const chaperones = [...new Set(submissionsData.map(s => s.group_name).filter(c => c))].sort();
      const chaperoneSelect = document.getElementById('chaperoneFilter');
      chaperones.forEach(chap => {
        const option = document.createElement('option');
        option.value = chap;
        option.textContent = chap;
        chaperoneSelect.appendChild(option);
      });
      
      // Chaperone filter change handler
      chaperoneSelect.addEventListener('change', (e) => {
        activeFilters.chaperone = e.target.value;
        const filteredSubs = getFilteredSubmissions();
        renderAnalytics(filteredSubs);
      });
      
      renderAnalytics(submissionsData);
      initializeItineraryBuilder();
      setupDataExport(submissionsData);
      await loadChaperones();
      setupChaperoneManagement();
    }
    
    async function loadChaperones() {
      const chapsSnap = await getDocs(collection(db, 'chaperones'));
      const chaperones = chapsSnap.docs.map(d => ({ id: d.id, name: d.data().name })).sort((a, b) => a.name.localeCompare(b.name));
      
      // Render chaperone list in management tab
      const chaperonesList = document.getElementById('chaperonesList');
      chaperonesList.innerHTML = '';
      
      if (chaperones.length === 0) {
        chaperonesList.innerHTML = '<p style="color: var(--color-text-muted); text-align: center; padding: 2rem;">No chaperones added yet.</p>';
      } else {
        chaperones.forEach(chap => {
          const item = document.createElement('div');
          item.className = 'chaperone-item';
          item.innerHTML = `
            <span class="name">${chap.name}</span>
            <button type="button" class="delete-btn" data-id="${chap.id}">üóëÔ∏è Remove</button>
          `;
          item.querySelector('.delete-btn').addEventListener('click', async (e) => {
            if (confirm(`Remove ${chap.name} from the chaperone list?`)) {
              await deleteDoc(doc(db, 'chaperones', chap.id));
              loadChaperones();
            }
          });
          chaperonesList.appendChild(item);
        });
      }
      
      // Update chaperone filter dropdown
      const chaperoneSelect = document.getElementById('chaperoneFilter');
      const currentValue = chaperoneSelect.value;
      chaperoneSelect.innerHTML = '<option value="all">All Students (Full Group)</option>';
      chaperones.forEach(chap => {
        const option = document.createElement('option');
        option.value = chap.name;
        option.textContent = chap.name;
        chaperoneSelect.appendChild(option);
      });
      chaperoneSelect.value = currentValue;
    }
    
    function setupChaperoneManagement() {
      // Add chaperone button handler
      const addBtn = document.getElementById('addChaperoneBtn');
      const input = document.getElementById('newChaperoneName');
      
      if (!addBtn || !input) {
        console.error('Chaperone management elements not found');
        return;
      }
      
      addBtn.addEventListener('click', async () => {
        const name = input.value.trim();
        
        if (!name) {
          alert('Please enter a chaperone name.');
          return;
        }
        
        try {
          // Check for duplicates
          const existing = await getDocs(collection(db, 'chaperones'));
          const duplicate = existing.docs.find(d => d.data().name.toLowerCase() === name.toLowerCase());
          
          if (duplicate) {
            alert('This chaperone already exists in the list.');
            return;
          }
          
          // Add to Firestore
          await setDoc(doc(collection(db, 'chaperones')), { name });
          input.value = '';
          await loadChaperones();
          alert(`‚úÖ ${name} added successfully!`);
        } catch (err) {
          console.error('Error adding chaperone:', err);
          alert(`‚ùå Error adding chaperone: ${err.message}`);
        }
      });
      
      // Allow Enter key to add chaperone
      input.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          addBtn.click();
        }
      });
    }
    
    function getFilteredSubmissions() {
      if (activeFilters.chaperone === 'all') {
        return submissionsData;
      }
      return submissionsData.filter(s => s.group_name === activeFilters.chaperone);
    }

    function renderAnalytics(subs) {
      const total = subs.length;
      const comfortCounts = {1:0,2:0,3:0,4:0,5:0};
      const themes = {};
      const avoidCounts = {};
      const buckets = {thrill:0, flexible:0, cautious:0};

      subs.forEach(s => {
        const c = Number(s.coaster_comfort||0);
        if (comfortCounts[c] != null) comfortCounts[c]++;
        if (c >= 4) buckets.thrill++;
        else if (c === 3) buckets.flexible++;
        else if (c > 0) buckets.cautious++;

        (s.top_themes||[]).forEach(t => {
          const k = t.trim().toLowerCase();
          if (k) themes[k] = (themes[k]||0) + 1;
        });

        const avoidText = [
          ...(s.avoid_ride_list || []),
          s.usf_choices||"", s.ioa_choices||"", s.epic_choices||"", s.parent_restrictions||""
        ].join(" ").toLowerCase();

        ["velocicoaster","hulk","rip ride rockit","hagrid","dark universe","scary","heights","motion sickness","simulator"].forEach(k => {
          if (avoidText.includes(k)) avoidCounts[k] = (avoidCounts[k]||0) + 1;
        });
      });

      // Stats cards
      document.getElementById('statsRow').innerHTML = `
        <div class="stat-card">
          <div class="stat-number">${total}</div>
          <div class="stat-label">Total Submissions</div>
        </div>
        <div class="stat-card">
          <div class="stat-number">${buckets.thrill}</div>
          <div class="stat-label">Thrill Seekers</div>
        </div>
        <div class="stat-card">
          <div class="stat-number">${buckets.flexible}</div>
          <div class="stat-label">Flexible</div>
        </div>
        <div class="stat-card">
          <div class="stat-number">${buckets.cautious}</div>
          <div class="stat-label">Cautious</div>
        </div>
      `;

      // Coaster Comfort Chart (Bar)
      if (charts.comfort) charts.comfort.destroy();
      charts.comfort = new Chart(document.getElementById('comfortChart'), {
        type: 'bar',
        data: {
          labels: ['1 (No way)', '2', '3 (Okay)', '4', '5 (Love)'],
          datasets: [{
            label: 'Students',
            data: [comfortCounts[1], comfortCounts[2], comfortCounts[3], comfortCounts[4], comfortCounts[5]],
            backgroundColor: ['#ef4444', '#fb923c', '#fbbf24', '#4ade80', '#22c55e']
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } }
        }
      });

      // Thrill Breakdown (Doughnut)
      if (charts.thrill) charts.thrill.destroy();
      charts.thrill = new Chart(document.getElementById('thrillChart'), {
        type: 'doughnut',
        data: {
          labels: ['Thrill', 'Flexible', 'Cautious'],
          datasets: [{
            data: [buckets.thrill, buckets.flexible, buckets.cautious],
            backgroundColor: ['#22c55e', '#fbbf24', '#ef4444']
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false
        }
      });

      // Top Themes (Horizontal Bar)
      const topThemes = Object.entries(themes).sort((a,b) => b[1] - a[1]).slice(0, 8);
      if (charts.themes) charts.themes.destroy();
      charts.themes = new Chart(document.getElementById('themesChart'), {
        type: 'bar',
        data: {
          labels: topThemes.map(([k]) => k),
          datasets: [{
            label: 'Requests',
            data: topThemes.map(([,v]) => v),
            backgroundColor: '#2563eb'
          }]
        },
        options: {
          indexAxis: 'y',
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } }
        }
      });

      // Avoids (Bar)
      const topAvoids = Object.entries(avoidCounts).sort((a,b) => b[1] - a[1]).slice(0, 8);
      if (charts.avoids) charts.avoids.destroy();
      charts.avoids = new Chart(document.getElementById('avoidsChart'), {
        type: 'bar',
        data: {
          labels: topAvoids.map(([k]) => k),
          datasets: [{
            label: 'Students',
            data: topAvoids.map(([,v]) => v),
            backgroundColor: '#dc2626'
          }]
        },
        options: {
          indexAxis: 'y',
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } }
        }
      });
    }

    function initializeItineraryBuilder() {
      const attractions = [
        // IOA - Thrill Rides
        {name: "VelociCoaster", park: "IOA", category: "üé¢", type: "Thrill Ride"},
        {name: "Hulk", park: "IOA", category: "üé¢", type: "Thrill Ride"},
        {name: "Hagrid's Magical Creatures", park: "IOA", category: "üé¢", type: "Thrill Ride"},
        {name: "Doctor Doom's Fearfall", park: "IOA", category: "üé¢", type: "Thrill Ride"},
        
        // IOA - Family Rides
        {name: "Harry Potter - Forbidden Journey", park: "IOA", category: "üé°", type: "Family Ride"},
        {name: "Flight of the Hippogriff", park: "IOA", category: "üé°", type: "Family Ride"},
        {name: "Spider-Man", park: "IOA", category: "üé°", type: "Family Ride"},
        {name: "Jurassic World River Adventure", park: "IOA", category: "üé°", type: "Family Ride"},
        {name: "Skull Island: Reign of Kong", park: "IOA", category: "üé°", type: "Family Ride"},
        {name: "Poseidon's Fury", park: "IOA", category: "üé°", type: "Family Ride"},
        {name: "Cat in the Hat", park: "IOA", category: "üé°", type: "Family Ride"},
        {name: "One Fish Two Fish", park: "IOA", category: "üé°", type: "Family Ride"},
        {name: "Caro-Seuss-el", park: "IOA", category: "üé°", type: "Family Ride"},
        {name: "Storm Force Accelatron", park: "IOA", category: "üé°", type: "Family Ride"},
        
        // IOA - Shows & Interactive
        {name: "Raptor Encounter", park: "IOA", category: "üé≠", type: "Show"},
        {name: "Ollivanders Wand Shop", park: "IOA", category: "üé™", type: "Interactive"},
        {name: "Seuss Landing Play Area", park: "IOA", category: "üé™", type: "Interactive"},
        
        // IOA - Dining
        {name: "Three Broomsticks", park: "IOA", category: "üçî", type: "Dining"},
        {name: "Mythos Restaurant", park: "IOA", category: "üçî", type: "Dining"},
        {name: "Thunder Falls Terrace", park: "IOA", category: "üçî", type: "Dining"},
        {name: "Confisco Grille", park: "IOA", category: "üçî", type: "Dining"},
        {name: "Comic Strip Cafe", park: "IOA", category: "üçî", type: "Dining"},
        {name: "Green Eggs and Ham Cafe", park: "IOA", category: "üçî", type: "Dining"},
        {name: "Croissant Moon Bakery", park: "IOA", category: "üçî", type: "Dining"},
        {name: "The Burger Digs", park: "IOA", category: "üçî", type: "Dining"},
        {name: "Pizza Predattoria", park: "IOA", category: "üçî", type: "Dining"},
        {name: "Blondie's", park: "IOA", category: "üçî", type: "Dining"},
        {name: "Circus McGurkus", park: "IOA", category: "üçî", type: "Dining"},
        {name: "Hop on Pop Ice Cream", park: "IOA", category: "üçî", type: "Dining"},
        
        // USF - Thrill Rides
        {name: "Rip Ride Rockit", park: "USF", category: "üé¢", type: "Thrill Ride"},
        
        // USF - Family Rides
        {name: "Harry Potter - Gringotts", park: "USF", category: "üé°", type: "Family Ride"},
        {name: "Revenge of the Mummy", park: "USF", category: "üé°", type: "Family Ride"},
        {name: "Transformers", park: "USF", category: "üé°", type: "Family Ride"},
        {name: "Men in Black", park: "USF", category: "üé°", type: "Family Ride"},
        {name: "E.T. Adventure", park: "USF", category: "üé°", type: "Family Ride"},
        {name: "Minions Mayhem", park: "USF", category: "üé°", type: "Family Ride"},
        {name: "The Simpsons Ride", park: "USF", category: "üé°", type: "Family Ride"},
        {name: "Fast & Furious", park: "USF", category: "üé°", type: "Family Ride"},
        {name: "Kang & Kodos' Twirl 'n' Hurl", park: "USF", category: "üé°", type: "Family Ride"},
        {name: "Woody Woodpecker Coaster", park: "USF", category: "üé°", type: "Family Ride"},
        
        // USF - Shows
        {name: "Horror Make-Up Show", park: "USF", category: "üé≠", type: "Show"},
        {name: "Animal Actors", park: "USF", category: "üé≠", type: "Show"},
        {name: "Bourne Stuntacular", park: "USF", category: "üé≠", type: "Show"},
        
        // USF - Interactive
        {name: "Diagon Alley Exploration", park: "USF", category: "üé™", type: "Interactive"},
        {name: "Springfield Area", park: "USF", category: "üé™", type: "Interactive"},
        
        // USF - Dining
        {name: "Leaky Cauldron", park: "USF", category: "üçî", type: "Dining"},
        {name: "Florean Fortescue Ice Cream", park: "USF", category: "üçî", type: "Dining"},
        {name: "Finnegan's Bar & Grill", park: "USF", category: "üçî", type: "Dining"},
        {name: "Lombard's Seafood Grille", park: "USF", category: "üçî", type: "Dining"},
        {name: "Today Cafe", park: "USF", category: "üçî", type: "Dining"},
        {name: "Mel's Drive-In", park: "USF", category: "üçî", type: "Dining"},
        {name: "Louie's Italian Restaurant", park: "USF", category: "üçî", type: "Dining"},
        {name: "Fast Food Boulevard", park: "USF", category: "üçî", type: "Dining"},
        {name: "San Francisco Pastry Co.", park: "USF", category: "üçî", type: "Dining"},
        {name: "Richter's Burger Co.", park: "USF", category: "üçî", type: "Dining"},
        {name: "Schwab's Pharmacy", park: "USF", category: "üçî", type: "Dining"},
        {name: "Beverly Hills Boulangerie", park: "USF", category: "üçî", type: "Dining"},
        {name: "Bumblebee Man's Taco Truck", park: "USF", category: "üçî", type: "Dining"},
        {name: "Lard Lad Donuts", park: "USF", category: "üçî", type: "Dining"},
        {name: "Ben & Jerry's", park: "USF", category: "üçî", type: "Dining"},
        
        // Epic Universe
        {name: "Super Nintendo World - Mario Kart", park: "Epic", category: "üé°", type: "Family Ride"},
        {name: "How to Train Your Dragon", park: "Epic", category: "üé°", type: "Family Ride"},
        {name: "Ministry of Magic Ride", park: "Epic", category: "üé°", type: "Family Ride"},
        {name: "Dark Universe Attraction", park: "Epic", category: "üé°", type: "Family Ride"},
        {name: "Super Nintendo World Exploration", park: "Epic", category: "üé™", type: "Interactive"},
        {name: "Ministry of Magic Exploration", park: "Epic", category: "üé™", type: "Interactive"},
        {name: "Toadstool Cafe", park: "Epic", category: "üçî", type: "Dining"},
        {name: "Epic Universe Dining", park: "Epic", category: "üçî", type: "Dining"}
      ];

      const schedule = {
        thursday: ["2:00 PM", "3:00 PM", "4:00 PM", "5:00 PM", "6:00 PM"],
        friday: ["9:00 AM", "10:00 AM", "11:00 AM", "12:00 PM", "1:00 PM", "2:00 PM", "3:00 PM", "4:00 PM", "5:00 PM", "6:00 PM"],
        saturday: ["9:00 AM", "10:00 AM", "11:00 AM", "12:00 PM", "1:00 PM", "2:00 PM", "3:00 PM", "4:00 PM", "5:00 PM"]
      };

      // Store attractions globally
      allAttractions = attractions;
      
      // Setup filter event listeners
      document.querySelectorAll('#categoryFilters .filter-chip').forEach(chip => {
        chip.addEventListener('click', (e) => {
          document.querySelectorAll('#categoryFilters .filter-chip').forEach(c => c.classList.remove('active'));
          e.target.classList.add('active');
          activeFilters.category = e.target.dataset.category;
          renderFilteredAttractions();
        });
      });
      
      document.querySelectorAll('#parkFilters .filter-chip').forEach(chip => {
        chip.addEventListener('click', (e) => {
          document.querySelectorAll('#parkFilters .filter-chip').forEach(c => c.classList.remove('active'));
          e.target.classList.add('active');
          activeFilters.park = e.target.dataset.park;
          renderFilteredAttractions();
        });
      });
      
      // Initial render
      renderFilteredAttractions();
      
      function renderFilteredAttractions() {
        const attractionsList = document.getElementById('attractionsList');
        attractionsList.innerHTML = '';
        
        const filtered = allAttractions.filter(attr => {
          const categoryMatch = activeFilters.category === 'all' || attr.category === activeFilters.category;
          const parkMatch = activeFilters.park === 'all' || attr.park === activeFilters.park;
          return categoryMatch && parkMatch;
        });
        
        if (filtered.length === 0) {
          attractionsList.innerHTML = '<div style="padding: 1rem; text-align: center; color: var(--color-text-muted);">No attractions match filters</div>';
          return;
        }
        
        filtered.forEach(attr => {
          const card = document.createElement('div');
          card.className = 'attraction-card';
          card.draggable = true;
          card.dataset.attraction = JSON.stringify(attr);
          card.innerHTML = `
            <div class="attraction-name">${attr.category} ${attr.name}</div>
            <div class="attraction-park">${attr.park} ‚Ä¢ ${attr.type}</div>
          `;
          card.addEventListener('dragstart', handleDragStart);
          card.addEventListener('dragend', handleDragEnd);
          attractionsList.appendChild(card);
        });
      }

      // Auto-generate button
      document.getElementById('autoGenerateBtn').addEventListener('click', () => {
        const filteredSubs = getFilteredSubmissions();
        if (!filteredSubs || filteredSubs.length === 0) {
          alert('No survey data available for selected chaperone group.');
          return;
        }
        const chaperoneText = activeFilters.chaperone === 'all' ? 'all students' : activeFilters.chaperone;
        if (confirm(`Generate itinerary based on survey data from ${chaperoneText}?`)) {
          generateSuggestedItinerary(filteredSubs, allAttractions, schedule);
        }
      });

      // Clear schedule button
      document.getElementById('clearScheduleBtn').addEventListener('click', () => {
        if (confirm('Clear entire schedule?')) {
          document.querySelectorAll('.timeslot-items').forEach(container => {
            container.innerHTML = '';
          });
        }
      });

      // Render schedule grid
      const scheduleGrid = document.getElementById('scheduleGrid');
      ['thursday', 'friday', 'saturday'].forEach(day => {
        const dayCard = document.createElement('div');
        dayCard.className = 'day-schedule';
        dayCard.innerHTML = `<h3>${day.charAt(0).toUpperCase() + day.slice(1)}</h3><div class="timeslots" id="${day}-slots"></div>`;
        scheduleGrid.appendChild(dayCard);

        const slotsContainer = document.getElementById(`${day}-slots`);
        schedule[day].forEach(time => {
          const slot = document.createElement('div');
          slot.className = 'timeslot';
          slot.dataset.day = day;
          slot.dataset.time = time;
          slot.innerHTML = `
            <div class="timeslot-header">${time}</div>
            <div class="timeslot-items"></div>
          `;
          slot.addEventListener('dragover', handleDragOver);
          slot.addEventListener('dragleave', handleDragLeave);
          slot.addEventListener('drop', handleDrop);
          slotsContainer.appendChild(slot);
        });
      });
    }

    let draggedElement = null;

    function handleDragStart(e) {
      draggedElement = this;
      this.classList.add('dragging');
      e.dataTransfer.effectAllowed = 'copy';
      e.dataTransfer.setData('text/html', this.innerHTML);
    }

    function handleDragEnd(e) {
      this.classList.remove('dragging');
    }

    function handleDragOver(e) {
      if (e.preventDefault) e.preventDefault();
      e.dataTransfer.dropEffect = 'copy';
      this.classList.add('drag-over');
      return false;
    }

    function handleDragLeave(e) {
      this.classList.remove('drag-over');
    }

    function handleDrop(e) {
      if (e.stopPropagation) e.stopPropagation();
      this.classList.remove('drag-over');

      if (draggedElement) {
        const data = JSON.parse(draggedElement.dataset.attraction);
        const itemsContainer = this.querySelector('.timeslot-items');
        
        const scheduledItem = document.createElement('div');
        scheduledItem.className = 'scheduled-item';
        scheduledItem.innerHTML = `
          <span>${data.category} <strong>${data.name}</strong> (${data.park})</span>
          <button type="button" class="remove-btn" onclick="this.parentElement.remove()">√ó</button>
        `;
        itemsContainer.appendChild(scheduledItem);
      }

      return false;
    }

    function generateSuggestedItinerary(subs, attractions, schedule) {
      // Clear existing schedule
      document.querySelectorAll('.timeslot-items').forEach(container => {
        container.innerHTML = '';
      });

      // Analyze survey data
      const comfortSum = subs.reduce((sum, s) => sum + Number(s.coaster_comfort || 0), 0);
      const avgComfort = comfortSum / subs.length;
      const thrillCount = subs.filter(s => Number(s.coaster_comfort) >= 4).length;
      const cautiousCount = subs.filter(s => Number(s.coaster_comfort) <= 2).length;
      
      const allThemes = subs.flatMap(s => (s.top_themes || []).map(t => t.toLowerCase()));
      const themeCounts = {};
      allThemes.forEach(t => {
        if (t) themeCounts[t] = (themeCounts[t] || 0) + 1;
      });

      const avoidText = subs.flatMap(s => [
        ...(s.avoid_ride_list || []),
        s.usf_choices || "",
        s.ioa_choices || "",
        s.epic_choices || "",
        s.parent_restrictions || ""
      ]).join(" ").toLowerCase();

      // Build suggested itinerary
      const suggested = {
        thursday: [],
        friday: [],
        saturday: []
      };

      // Thursday (2PM-6PM arrival day, lighter schedule)
      suggested.thursday = [
        attractions.find(a => a.name.includes("Diagon Alley")),
        attractions.find(a => a.name === "Harry Potter - Gringotts"),
        attractions.find(a => a.name === "Leaky Cauldron"),
        attractions.find(a => a.name === "Florean Fortescue Ice Cream"),
        attractions.find(a => a.name === "Bourne Stuntacular")
      ];

      // Friday (Full day - IOA focus)
      if (avgComfort >= 3.5) {
        // Thrill-heavy group
        suggested.friday = [
          attractions.find(a => a.name === "VelociCoaster"),
          attractions.find(a => a.name === "Three Broomsticks"),
          attractions.find(a => a.name === "Hagrid's Magical Creatures"),
          attractions.find(a => a.name === "Harry Potter - Forbidden Journey"),
          attractions.find(a => a.name === "Mythos Restaurant"),
          !avoidText.includes("hulk") ? attractions.find(a => a.name === "Hulk") : attractions.find(a => a.name === "Spider-Man"),
          attractions.find(a => a.name === "Jurassic World River Adventure"),
          attractions.find(a => a.name === "Hop on Pop Ice Cream"),
          attractions.find(a => a.name === "Skull Island: Reign of Kong"),
          attractions.find(a => a.name === "Cat in the Hat")
        ];
      } else {
        // Family-friendly group
        suggested.friday = [
          attractions.find(a => a.name === "Harry Potter - Forbidden Journey"),
          attractions.find(a => a.name === "Three Broomsticks"),
          attractions.find(a => a.name === "Flight of the Hippogriff"),
          attractions.find(a => a.name === "Ollivanders Wand Shop"),
          attractions.find(a => a.name === "Mythos Restaurant"),
          attractions.find(a => a.name === "Spider-Man"),
          attractions.find(a => a.name === "Cat in the Hat"),
          attractions.find(a => a.name === "Hop on Pop Ice Cream"),
          attractions.find(a => a.name === "Seuss Landing Play Area"),
          attractions.find(a => a.name === "One Fish Two Fish")
        ];
      }

      // Saturday (Epic Universe or mixed)
      if (themeCounts['nintendo'] >= subs.length * 0.3 || themeCounts['super nintendo'] >= subs.length * 0.3) {
        suggested.saturday = [
          attractions.find(a => a.name === "Super Nintendo World - Mario Kart"),
          attractions.find(a => a.name === "Super Nintendo World Exploration"),
          attractions.find(a => a.name === "Toadstool Cafe"),
          attractions.find(a => a.name === "Ministry of Magic Ride"),
          attractions.find(a => a.name === "Ministry of Magic Exploration"),
          attractions.find(a => a.name === "Epic Universe Dining"),
          !avoidText.includes("dark universe") ? attractions.find(a => a.name === "Dark Universe Attraction") : attractions.find(a => a.name === "How to Train Your Dragon"),
          attractions.find(a => a.name === "How to Train Your Dragon"),
          attractions.find(a => a.name === "Epic Universe Dining")
        ];
      } else {
        // Mixed day with USF
        suggested.saturday = [
          attractions.find(a => a.name === "E.T. Adventure"),
          attractions.find(a => a.name === "Revenge of the Mummy"),
          attractions.find(a => a.name === "Today Cafe"),
          attractions.find(a => a.name === "Transformers"),
          !avoidText.includes("rip ride rockit") && avgComfort >= 3.5 ? attractions.find(a => a.name === "Rip Ride Rockit") : attractions.find(a => a.name === "Minions Mayhem"),
          attractions.find(a => a.name === "Fast Food Boulevard"),
          attractions.find(a => a.name === "The Simpsons Ride"),
          attractions.find(a => a.name === "Lard Lad Donuts"),
          attractions.find(a => a.name === "Men in Black")
        ];
      }

      // Place attractions into timeslots
      ['thursday', 'friday', 'saturday'].forEach(day => {
        const daySlots = document.querySelectorAll(`.timeslot[data-day="${day}"]`);
        const dayAttractions = suggested[day].filter(a => a != null);
        
        dayAttractions.forEach((attr, idx) => {
          if (idx < daySlots.length && attr) {
            const slot = daySlots[idx];
            const itemsContainer = slot.querySelector('.timeslot-items');
            const scheduledItem = document.createElement('div');
            scheduledItem.className = 'scheduled-item';
            scheduledItem.innerHTML = `
              <span>${attr.category} <strong>${attr.name}</strong> (${attr.park})</span>
              <button type="button" class="remove-btn" onclick="this.parentElement.remove()">√ó</button>
            `;
            itemsContainer.appendChild(scheduledItem);
          }
        });
      });

      alert('‚ú® Suggested itinerary generated based on survey responses! Feel free to drag & drop to customize.');
    }

    function setupDataExport(subs) {
      const total = subs.length;
      document.getElementById('summary').innerHTML = `
        <p><strong>Total Submissions:</strong> ${total}</p>
        <p style="color: var(--color-text-muted); font-size: 0.9rem;">Click the button below to download all submission data as JSON.</p>
      `;

      document.getElementById('download').onclick = () => {
        const blob = new Blob([JSON.stringify({ submissions: subs }, null, 2)], {type:'application/json'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'universal_band_trip_responses.json';
        a.click();
        URL.revokeObjectURL(a.href);
        document.getElementById('status').textContent = 'Downloaded!';
        setTimeout(() => document.getElementById('status').textContent = '', 3000);
      };
    }
  </script>
  <script>
    (function(){
      const btn = document.getElementById('theme-selector');
      const root = document.documentElement;
      const themes = ['light','dark','universal'];
      const icons = { light: '‚òÄÔ∏è', dark: 'üåô', universal: 'üåê' };
      const labels = { light: 'Light', dark: 'Dark', universal: 'Universal' };
      function applyTheme(t){
        root.classList.remove('theme-dark','theme-universal');
        if (t === 'dark') root.classList.add('theme-dark');
        if (t === 'universal') root.classList.add('theme-universal');
        localStorage.setItem('theme', t);
        if (!btn) return;
        btn.querySelector('.icon').textContent = icons[t] || '';
        btn.querySelector('.label').textContent = labels[t] || t;
      }
      const stored = localStorage.getItem('theme');
      const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
      const start = stored || (prefersDark ? 'dark' : 'light');
      applyTheme(start);
      if (btn) {
        btn.addEventListener('click', () => {
          const cur = localStorage.getItem('theme') || (prefersDark ? 'dark' : 'light');
          const next = themes[(themes.indexOf(cur) + 1) % themes.length];
          applyTheme(next);
        });
      }
    })();
  </script>
</body>
</html>
