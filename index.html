<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Universal Trip Preferences</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="preload" as="style" href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap">
  <link rel="preload" as="style" href="https://fonts.googleapis.com/css2?family=Monoton&display=swap">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Monoton&display=swap" rel="stylesheet">
  <link href="./styles.css" rel="stylesheet" />
</head>
<body>
  <div class="app-shell">
    <a href="admin.html" class="admin-link" title="Admin Portal">Admin</a>
    <header class="app-header">
      <div class="app-title-row">
        <div class="app-title">
          <span class="icon">üé∫</span>
          <span class="universal-title">Universal Trip Preferences</span>
          <div class="decorative-subtitle monoton-regular">An Epic Universal Adventure</div>
        </div>
        <div class="theme-selector" aria-hidden="false">
          <button id="theme-selector" aria-label="Theme selector" title="Change theme"><span class="icon">‚òÄÔ∏è</span><span class="label">Light</span></button>
        </div>
        <span class="app-badge">Band ‚Ä¢ Middle School</span>
      </div>
      <p class="app-subtitle">
        Tell us what you like so we can build the best route through Universal Studios, Islands of Adventure, and Epic Universe.
      </p>
    </header>
  <main>
        <div class="card">
          <div class="section-title monoton-regular">Student Info</div>

  <form id="prefForm" class="card">
    <label class="required">Student Name</label>
    <input name="student_name" required />

    <label>Instrument / Section</label>
    <select name="instrument">
      <option value="">Select your section</option>
      <option value="Flute/Piccolo">Flute/Piccolo</option>
      <option value="Clarinet">Clarinet</option>
      <option value="Saxophone">Saxophone</option>
      <option value="Oboe/Bassoon">Oboe/Bassoon</option>
      <option value="Trumpet">Trumpet</option>
      <option value="French Horn">French Horn</option>
      <option value="Trombone">Trombone</option>
      <option value="Baritone/Euphonium">Baritone/Euphonium</option>
      <option value="Tuba">Tuba</option>
      <option value="Percussion">Percussion</option>
      <option value="Drum Line">Drum Line</option>
      <option value="Front Ensemble/Pit">Front Ensemble/Pit</option>
      <option value="Color Guard">Color Guard</option>
      <option value="Drum Major">Drum Major</option>
    </select>

    <label class="required">Chaperone</label>
    <select name="group_name" id="group_name" required>
      <option value="">Loading chaperones...</option>
    </select>

    <label>Have you ever been to Universal Orlando?</label>
    <select name="been_before">
      <option value="">Select</option>
      <option>No, first time</option>
      <option>Yes, once</option>
      <option>Yes, multiple times</option>
    </select>

    <label>Have you ridden big roller coasters before?</label>
    <select name="ridden_coasters_before">
      <option value="">Select</option>
      <option>Yes, and I like them</option>
      <option>Yes, but I didn't like them</option>
      <option>Only small / kiddie coasters</option>
      <option>No</option>
    </select>

    <label class="required">How do you feel about roller coasters? (1=no way, 5=love)</label>
    <select name="coaster_comfort" required>
      <option value="">Select</option>
      <option>1</option><option>2</option><option>3</option>
      <option>4</option><option>5</option>
    </select>

    <label>Sensitivities</label>
    <div class="chips">
      <label><input type="checkbox" name="sensitivities" value="Motion sickness"> Motion sickness</label>
      <label><input type="checkbox" name="sensitivities" value="Heights"> Heights</label>
      <label><input type="checkbox" name="sensitivities" value="Fast drops"> Fast drops</label>
      <label><input type="checkbox" name="sensitivities" value="Scary / dark"> Scary / dark</label>
      <label><input type="checkbox" name="sensitivities" value="None"> None</label>
    </div>

    <label>Top Interests (select up to 5)</label>
    <div class="chips">
      <label><input type="checkbox" name="top_themes" value="Harry Potter"> Harry Potter</label>
      <label><input type="checkbox" name="top_themes" value="Super Nintendo World"> Super Nintendo World</label>
      <label><input type="checkbox" name="top_themes" value="Jurassic World"> Jurassic World</label>
      <label><input type="checkbox" name="top_themes" value="Marvel Super Hero Island"> Marvel</label>
      <label><input type="checkbox" name="top_themes" value="Transformers"> Transformers</label>
      <label><input type="checkbox" name="top_themes" value="The Simpsons"> The Simpsons</label>
      <label><input type="checkbox" name="top_themes" value="Minions"> Minions</label>
      <label><input type="checkbox" name="top_themes" value="How to Train Your Dragon"> How to Train Your Dragon</label>
      <label><input type="checkbox" name="top_themes" value="Dark Universe"> Dark Universe (Monsters)</label>
      <label><input type="checkbox" name="top_themes" value="Dr. Seuss"> Dr. Seuss</label>
      <label><input type="checkbox" name="top_themes" value="Ministry of Magic"> Ministry of Magic</label>
      <label><input type="checkbox" name="top_themes" value="Fast & Furious"> Fast & Furious</label>
    </div>

    <label>Any rides or experiences you want to avoid?</label>
    <div class="chips">
      <label><input type="checkbox" name="avoid_ride_list" value="VelociCoaster"> VelociCoaster (high thrill)</label>
      <label><input type="checkbox" name="avoid_ride_list" value="Hulk"> Hulk (inversions)</label>
      <label><input type="checkbox" name="avoid_ride_list" value="Rip Ride Rockit"> Rip Ride Rockit (steep drop)</label>
      <label><input type="checkbox" name="avoid_ride_list" value="Hagrid's"> Hagrid's (moderate thrill)</label>
      <label><input type="checkbox" name="avoid_ride_list" value="Scary/Dark rides"> Scary or dark themed rides</label>
      <label><input type="checkbox" name="avoid_ride_list" value="Simulators"> Simulator rides (motion sickness)</label>
      <label><input type="checkbox" name="avoid_ride_list" value="Water rides"> Water rides (getting wet)</label>
      <label><input type="checkbox" name="avoid_ride_list" value="Spinning rides"> Spinning rides</label>
      <label><input type="checkbox" name="avoid_ride_list" value="Heights"> Rides with heights/drops</label>
      <label><input type="checkbox" name="avoid_ride_list" value="3D experiences"> 3D glasses experiences</label>
    </div>

    <label>Universal Studios (USF) thoughts</label>
    <textarea name="usf_choices"></textarea>

    <label>Islands of Adventure (IOA) thoughts</label>
    <textarea name="ioa_choices"></textarea>

    <label>Epic Universe thoughts</label>
    <textarea name="epic_choices"></textarea>

    <label>Parent/Guardian ride rules</label>
    <textarea name="parent_restrictions"></textarea>

    <label>Anything else?</label>
    <textarea name="notes"></textarea>

    <button type="submit">Submit</button>
    <div id="status"></div>
  </form>

  <script type="module">
    //remove this code in Github repo version
    // App Check initialization is handled in `firebase-init.js` (modular imports).
    // The inline call here duplicated the initialization and ran before imports,
    // causing `initializeAppCheck` to be undefined. Removed.

    import { db, auth, ensureAnonymousAuth, serverTimestamp } from './firebase-init.js';
    import { collection, addDoc, getDocs } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-firestore.js";

    // Safety check: if App Check debug token was enabled, warn so you don't ship it to production.
    if (self.FIREBASE_APPCHECK_DEBUG_TOKEN) {
      console.warn('App Check debug token is enabled (firebase-init.js). Ensure this is disabled before publishing to production.');
    }

    const form = document.getElementById('prefForm');
    let chaperonesLoaded = false;
    
    // Load chaperones from Firestore
    async function loadChaperones() {
      try {
        const chapsSnap = await getDocs(collection(db, 'chaperones'));
        const chaperones = chapsSnap.docs.map(d => d.data().name).sort();
        const select = document.getElementById('group_name');
        select.innerHTML = '<option value="">Select your chaperone</option>';
        
        if (chaperones.length === 0) {
          select.innerHTML = '<option value="">No chaperones available</option>';
        } else {
          chaperones.forEach(name => {
            const option = document.createElement('option');
            option.value = name;
            option.textContent = name;
            select.appendChild(option);
          });
        }
        chaperonesLoaded = true;
      } catch (err) {
        console.error('Error loading chaperones:', err);
        const select = document.getElementById('group_name');
        select.innerHTML = '<option value="">Error loading chaperones</option>';
        chaperonesLoaded = true; // Allow submission even if loading fails
      }
    }
    
    loadChaperones();
    const statusEl = document.getElementById('status');

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      statusEl.textContent = "Submitting...";
      const fd = new FormData(form);

      const payload = {
        student_name: fd.get('student_name')?.trim(),
        instrument: fd.get('instrument') || "",
        group_name: fd.get('group_name') || "",
        been_before: fd.get('been_before') || "",
        ridden_coasters_before: fd.get('ridden_coasters_before') || "",
        coaster_comfort: parseInt(fd.get('coaster_comfort') || 0, 10),
        sensitivities: fd.getAll('sensitivities'),
        top_themes: fd.getAll('top_themes').filter(Boolean),
        avoid_ride_list: fd.getAll('avoid_ride_list').filter(Boolean),
        usf_choices: fd.get('usf_choices') || "",
        ioa_choices: fd.get('ioa_choices') || "",
        epic_choices: fd.get('epic_choices') || "",
        parent_restrictions: fd.get('parent_restrictions') || "",
        notes: fd.get('notes') || "",
        timestamp: serverTimestamp(),
      };

      try {
        await ensureAnonymousAuth(); // invisible to student
        payload.uid = auth.currentUser.uid;
        await addDoc(collection(db, 'submissions'), payload);
        statusEl.textContent = "Thanks! Your preferences were recorded.";
        form.reset();
      } catch (err) {
        console.error('Form submission error:', err);
        statusEl.textContent = `Error: ${err.code || err.message}`;
      }
    });
  </script>
  <script>
    (function(){
      const btn = document.getElementById('theme-selector');
      const root = document.documentElement;
      const themes = ['light','dark','universal'];
      const icons = { light: '‚òÄÔ∏è', dark: 'üåô', universal: 'üåê' };
      const labels = { light: 'Light', dark: 'Dark', universal: 'Universal' };
      function applyTheme(t){
        root.classList.remove('theme-dark','theme-universal');
        if (t === 'dark') root.classList.add('theme-dark');
        if (t === 'universal') root.classList.add('theme-universal');
        localStorage.setItem('theme', t);
        if (!btn) return;
        btn.querySelector('.icon').textContent = icons[t] || '';
        btn.querySelector('.label').textContent = labels[t] || t;
      }

      const stored = localStorage.getItem('theme');
      const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
      const start = stored || (prefersDark ? 'dark' : 'light');
      applyTheme(start);

      if (btn) {
        btn.addEventListener('click', () => {
          const cur = localStorage.getItem('theme') || (prefersDark ? 'dark' : 'light');
          const next = themes[(themes.indexOf(cur) + 1) % themes.length];
          applyTheme(next);
        });
      }
    })();
  </script>
</body>
</html>
